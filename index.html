<div class="ui-container">
    <div class="slider-box">
        <label id="density-label">PIXEL DENSITY: 150</label>
        <input type="range" id="density-slider" min="20" max="300" value="150">
    </div>
    <div class="btn-row">
        <button id="flip">ðŸ”„ ROTATE</button>
        <button id="color">MODE: FULL</button>
    </div>
    <button id="snap" style="background: #0f0; color: #000; font-weight: bold;">ðŸ“¸ TAKE SELFIE</button>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d', { alpha: false });
    const densitySlider = document.getElementById('density-slider');
    const densityLabel = document.getElementById('density-label');
    
    // Persistent offscreen canvas for performance
    const offscreen = document.createElement('canvas');
    const oCtx = offscreen.getContext('2d', { willReadFrequently: true });

    const CHARS = "$@B%8&WM#*oahkbdpqwmZO0QLCJUYXzcvunxrjft/\\|()1{}[]?-_+~<>i!lI;:,\"^`'. ";
    
    let currentCols = parseInt(densitySlider.value);
    let facingMode = "user"; // Default to selfie for a "selfie taker"
    let colorMode = 0; 
    const modes = ["FULL COLOR", "GREEN", "CYAN", "GRAYSCALE"];

    async function startCamera() {
        if (window.stream) {
            window.stream.getTracks().forEach(track => track.stop());
        }
        try {
            const s = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: facingMode, width: { ideal: 640 } }
            });
            window.stream = s;
            video.srcObject = s;
            video.play();
        } catch (e) { alert("Camera Access Denied"); }
    }

    function render() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            // Match canvas to window size
            if (canvas.width !== window.innerWidth || canvas.height !== window.innerHeight) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            const COLS = currentCols;
            const ROWS = Math.floor(COLS * (canvas.height / canvas.width));
            const cellW = canvas.width / COLS;
            const cellH = canvas.height / ROWS;

            offscreen.width = COLS;
            offscreen.height = ROWS;
            
            oCtx.save();
            if (facingMode === "user") {
                oCtx.translate(COLS, 0);
                oCtx.scale(-1, 1);
            }
            oCtx.drawImage(video, 0, 0, COLS, ROWS);
            oCtx.restore();

            const pixels = oCtx.getImageData(0, 0, COLS, ROWS).data;

            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.font = `bold ${cellH}px monospace`;
            ctx.textAlign = "center";

            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    const i = (y * COLS + x) * 4;
                    const r = pixels[i], g = pixels[i+1], b = pixels[i+2];
                    const brightness = (0.2126 * r + 0.7152 * g + 0.0722 * b);
                    
                    const charIdx = Math.floor((brightness / 256) * CHARS.length);
                    const char = CHARS[charIdx];

                    // Color Logic
                    if (colorMode === 0) ctx.fillStyle = `rgb(${r},${g},${b})`;
                    else if (colorMode === 1) ctx.fillStyle = `rgb(0,${brightness},0)`;
                    else if (colorMode === 2) ctx.fillStyle = `rgb(0,${brightness},${brightness})`;
                    else ctx.fillStyle = `rgb(${brightness},${brightness},${brightness})`;

                    ctx.fillText(char, x * cellW + cellW/2, y * cellH + (cellH * 0.8));
                }
            }
        }
        requestAnimationFrame(render);
    }

    // Capture Logic
    document.getElementById('snap').onclick = () => {
        const link = document.createElement('a');
        link.download = `ascii-selfie-${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    };

    densitySlider.addEventListener('input', (e) => {
        currentCols = parseInt(e.target.value);
        densityLabel.innerText = `PIXEL DENSITY: ${currentCols}`;
    });

    document.getElementById('flip').onclick = () => {
        facingMode = (facingMode === "user") ? "environment" : "user";
        startCamera();
    };

    document.getElementById('color').onclick = () => {
        colorMode = (colorMode + 1) % modes.length;
        document.getElementById('color').innerText = "MODE: " + modes[colorMode];
    };

    startCamera().then(() => requestAnimationFrame(render));
</script>

