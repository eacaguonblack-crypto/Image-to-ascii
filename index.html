<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ULTRA ASCII SMOOTH â€” FIXED</title>
    <style>
        body {
            margin: 0;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        /* We use a canvas for the display instead of a <pre> tag */
        canvas#display {
            display: block;
        }
        .ui {
            position: fixed;
            bottom: 30px;
            z-index: 10;
        }
        button {
            background: rgba(0,255,0,.25);
            color: #0f0;
            border: 1px solid #0f0;
            padding: 14px 22px;
            border-radius: 50px;
            font-family: monospace;
            font-size: 16px;
            cursor: pointer;
        }
        video { display: none; }
    </style>
</head>
<body>

<canvas id="display"></canvas>
<video id="video" autoplay playsinline muted></video>

<div class="ui">
    <button id="toggle">ROTATE CAMERA</button>
</div>

<script>
const video = document.getElementById("video");
const displayCanvas = document.getElementById("display");
const displayCtx = displayCanvas.getContext("2d", { alpha: false });

// Configuration
const COLS = 120; // Adjusted for better performance on mobile
const CHAR_ASPECT = 1.6; // Vertical spacing multiplier
const CHARS = " .:-=+*#%@";

let facingMode = "environment";
const hiddenCanvas = document.createElement("canvas");
const hiddenCtx = hiddenCanvas.getContext("2d", { alpha: false });

async function initCamera() {
    if (window.stream) {
        window.stream.getTracks().forEach(t => t.stop());
    }
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode }
        });
        window.stream = stream;
        video.srcObject = stream;
    } catch (err) {
        console.error("Camera error:", err);
    }
}

function render() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        const w = video.videoWidth;
        const h = video.videoHeight;
        const rows = Math.floor(COLS * (h / w) * 0.5); // Adjust rows based on aspect ratio

        hiddenCanvas.width = COLS;
        hiddenCanvas.height = rows;
        hiddenCtx.drawImage(video, 0, 0, COLS, rows);

        const imageData = hiddenCtx.getImageData(0, 0, COLS, rows);
        const data = imageData.data;

        // Prepare Display Canvas
        const fontSize = window.innerWidth / COLS;
        displayCanvas.width = window.innerWidth;
        displayCanvas.height = rows * fontSize * CHAR_ASPECT;
        
        displayCtx.fillStyle = "#000";
        displayCtx.fillRect(0, 0, displayCanvas.width, displayCanvas.height);
        displayCtx.font = `bold ${fontSize}px monospace`;
        displayCtx.textAlign = "left";

        for (let y = 0; y < rows; y++) {
            for (let x = 0; x < COLS; x++) {
                const p = (y * COLS + x) * 4;
                const r = data[p];
                const g = data[p + 1];
                const b = data[p + 2];

                const lum = (r * 0.299 + g * 0.587 + b * 0.114); // Better luminance formula
                const charIndex = Math.floor((lum / 255) * (CHARS.length - 1));
                const char = CHARS[charIndex];

                displayCtx.fillStyle = `rgb(${r},${g},${b})`;
                displayCtx.fillText(char, x * fontSize, y * fontSize * CHAR_ASPECT);
            }
        }
    }
    requestAnimationFrame(render);
}

document.getElementById("toggle").onclick = () => {
    facingMode = facingMode === "user" ? "environment" : "user";
    initCamera();
};

video.onloadedmetadata = () => {
    render();
};

initCamera();
</script>
</body>
</html>

